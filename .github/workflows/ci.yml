name: Fax Compiler CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

jobs:
  # Build and test
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-action@stable
      with:
        toolchain: stable

    - name: Install LLVM dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang \
          llvm \
          lld

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Build project
      run: cargo build --workspace --all-targets --release

    - name: Run tests
      run: cargo test --workspace --all-targets --release

    - name: Run clippy
      run: cargo clippy --workspace --all-targets -- -D warnings

    - name: Check formatting
      run: cargo fmt --all -- --check
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          target/debug/

  # Code quality checks
  code-quality:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-action@stable

    - name: Check formatting
      run: cargo fmt --all -- --check

    - name: Run clippy
      run: cargo clippy --workspace --all-targets -- -D warnings

  # Build Docker image
  docker-build:
    runs-on: ubuntu-latest
    needs: [build-and-test]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: docker build -t fax:latest .

    - name: Test Docker image
      run: |
        docker run --rm fax:latest --help
        docker run --rm -v $(pwd)/examples:/workspace/examples fax:latest examples/01_hello.fax

  # Release
  release:
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build]
    if: github.event_name == 'release'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-action@stable

    - name: Build release binary
      run: cargo build --release --bin faxc

    - name: Package release
      run: |
        mkdir -p release
        cp target/release/faxc release/
        cp -r examples release/
        cp README.md release/ 2>/dev/null || echo "No README.md"
        cp LICENSE release/ 2>/dev/null || echo "No LICENSE"
        tar -czvf fax-compiler-${{ github.ref_name }}.tar.gz release/

    - name: Upload release assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./fax-compiler-${{ github.ref_name }}.tar.gz
        asset_name: fax-compiler-${{ github.ref_name }}.tar.gz
        asset_content_type: application/gzip

  # Documentation
  documentation:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-action@stable

    - name: Generate documentation
      run: cargo doc --workspace --no-deps --document-private-items

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./target/doc
