name: Fax Compiler CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

jobs:
  # Build and test
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Lean 4
      uses: leanprover/lean-action@v1
      with:
        auto-config: true
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang \
          llvm \
          lld \
          protobuf-compiler \
          libprotobuf-dev
          
    - name: Build project
      run: lake build
      
    - name: Run unit tests
      run: |
        lake exe test-unit-lexer
        lake exe test-unit-parser
        lake exe test-unit-codegen
        lake exe test-unit-semantic
        lake exe test-unit-gc
        
    - name: Run integration tests
      run: lake exe test-integration
      
    - name: Run E2E tests
      run: lake exe test-e2e
      
    - name: Run benchmarks
      run: lake exe benchmark-gc
      
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: |
          test-results/
          benchmark-results/

  # Code quality checks
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Lean 4
      uses: leanprover/lean-action@v1
      
    - name: Check formatting
      run: |
        # Add formatting checks here
        echo "Checking code formatting..."
        
    - name: Run linting
      run: |
        # Add linting here
        echo "Running linter..."
        
    - name: Check documentation
      run: |
        # Check that documentation is up to date
        echo "Checking documentation..."

  # Build Docker image
  docker-build:
    runs-on: ubuntu-latest
    needs: [build-and-test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Build Docker image
      run: docker build -t fax:latest .
      
    - name: Test Docker image
      run: |
        docker run --rm fax:latest --help
        docker run --rm -v $(pwd)/examples:/workspace/examples fax:latest examples/01_hello.fax

  # Release
  release:
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build]
    if: github.event_name == 'release'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Lean 4
      uses: leanprover/lean-action@v1
      
    - name: Build release binary
      run: lake build --release
      
    - name: Package release
      run: |
        mkdir -p release
        cp .lake/build/bin/faxc release/
        cp -r examples release/
        cp README.md release/
        cp LICENSE release/
        tar -czvf fax-compiler-${{ github.ref_name }}.tar.gz release/
        
    - name: Upload release assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./fax-compiler-${{ github.ref_name }}.tar.gz
        asset_name: fax-compiler-${{ github.ref_name }}.tar.gz
        asset_content_type: application/gzip

  # Documentation
  documentation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Lean 4
      uses: leanprover/lean-action@v1
      
    - name: Generate documentation
      run: |
        # Generate API documentation
        echo "Generating documentation..."
        lake exe doc-gen
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/generated
