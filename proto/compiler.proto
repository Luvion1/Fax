syntax = "proto3";

package fax.compiler;

import "token.proto";
import "decl.proto";

// Compiler pipeline messages

// Request from client to Lexer service
message LexerRequest {
  string source_code = 1;
  string filename = 2;
}

// Response from Lexer service
message LexerResponse {
  oneof result {
    TokenStream tokens = 1;
    CompilerError error = 2;
  }
}

// Request from client/lexer to Parser service
message ParserRequest {
  oneof input {
    TokenStream tokens = 1;
    string source_code = 2;  // Alternative: parse from source directly
  }
  string filename = 3;
}

// Response from Parser service
message ParserResponse {
  oneof result {
    Module ast = 1;
    CompilerError error = 2;
  }
}

// Request to Codegen service
message CodegenRequest {
  Module ast = 1;
  CodegenOptions options = 2;
}

message CodegenOptions {
  string target_triple = 1;
  OptimizationLevel opt_level = 2;
  bool emit_debug_info = 3;
}

enum OptimizationLevel {
  OPT_NONE = 0;
  OPT_LESS = 1;
  OPT_DEFAULT = 2;
  OPT_AGGRESSIVE = 3;
}

// Response from Codegen service
message CodegenResponse {
  oneof result {
    string llvm_ir = 1;
    bytes object_file = 2;
    CompilerError error = 3;
  }
}

// Generic compiler error
message CompilerError {
  ErrorSeverity severity = 1;
  string message = 2;
  string code = 3;
  SourceRange location = 4;
  repeated string notes = 5;
}

enum ErrorSeverity {
  ERROR = 0;
  WARNING = 1;
  INFO = 2;
}

// Full compilation request
message CompileRequest {
  string source_code = 1;
  string filename = 2;
  CodegenOptions options = 3;
}

// Full compilation response
message CompileResponse {
  oneof result {
    CompileSuccess success = 1;
    CompileFailure failure = 2;
  }
}

message CompileSuccess {
  string llvm_ir = 1;
  bytes output_binary = 2;
  repeated CompilerError warnings = 3;
}

message CompileFailure {
  repeated CompilerError errors = 1;
}

// Service definitions for gRPC
service LexerService {
  rpc Tokenize(LexerRequest) returns (LexerResponse);
  rpc TokenizeStream(stream LexerRequest) returns (stream TokenStream);
}

service ParserService {
  rpc Parse(ParserRequest) returns (ParserResponse);
  rpc ParseTokens(TokenStream) returns (ParserResponse);
}

service CodegenService {
  rpc GenerateIR(CodegenRequest) returns (CodegenResponse);
  rpc GenerateObject(CodegenRequest) returns (CodegenResponse);
}

service CompilerService {
  rpc Compile(CompileRequest) returns (CompileResponse);
  rpc CompileStream(stream CompileRequest) returns (stream CompileResponse);
}
